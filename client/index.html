<!DOCTYPE html>
<html lang="pt-pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Watch Party</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #181818;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1 {
        color: #ffffff;
      }
      #main-content {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 1400px;
      }
      #player-section {
        flex-grow: 1;
        min-width: 500px;
        max-width: 900px;
      }
      #load-controls {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #282828;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }
      #load-controls input[type="text"] {
        padding: 12px;
        border: 1px solid #404040;
        background-color: #121212;
        color: #e0e0e0;
        border-radius: 8px;
        width: 350px;
        font-size: 14px;
      }
      #load-controls button {
        padding: 12px 20px;
        background: linear-gradient(90deg, #bb86fc, #9e6dff);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }
      #player-wrapper {
        width: 100%;
        margin: 0 auto;
      }
      #player-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        background-color: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      }
      #player {
        width: 100%;
        height: 100%;
      }
      #custom-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        background-color: #282828;
        margin-top: -6px;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
      }
      #play-pause-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
      }
      #play-pause-btn svg {
        width: 24px;
        height: 24px;
        fill: #e0e0e0;
      }
      #seek-slider {
        flex-grow: 1;
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 5px;
        background: #535353;
        border-radius: 5px;
        outline: none;
        cursor: pointer;
      }
      #seek-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        background: #bb86fc;
        border-radius: 50%;
        cursor: pointer;
      }
      #seek-slider::-moz-range-thumb {
        width: 15px;
        height: 15px;
        background: #bb86fc;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      #time-display {
        font-size: 14px;
        color: #a0a0a0;
        min-width: 90px;
      }
      #status {
        margin-top: 15px;
        font-style: italic;
        color: #a0a0a0;
        text-align: center;
      }

      #chat-section {
        flex-grow: 1;
        min-width: 300px;
        max-width: 400px;
        display: flex;
        flex-direction: column;
      }
      #chat-container {
        display: flex;
        flex-direction: column;
        background-color: #282828;
        border-radius: 12px;
        padding: 15px;
        height: 100%;
      }
      #chat-container h2 {
        margin-top: 0;
      }
      #chat-log {
        flex-grow: 1;
        background-color: #121212;
        border-radius: 8px;
        padding: 10px;
        overflow-y: scroll;
        margin-bottom: 10px;
        border: 1px solid #404040;
      }
      #chat-log p {
        margin: 0 0 8px 0;
        word-wrap: break-word;
        color: #e0e0e0;
      }
      #chat-log p strong {
        color: #bb86fc;
      }
      #chat-input-area {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #chat-input-area input {
        padding: 10px;
        border: 1px solid #404040;
        background-color: #121212;
        color: #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }
      #send-chat-btn {
        padding: 10px 15px;
        background-color: #03dac6;
        color: #000000;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>YouTube Watch Party</h1>
    <div id="load-controls">
      <input
        type="text"
        id="youtubeUrl"
        placeholder="Cole o URL do vídeo do YouTube aqui" />
      <button id="loadVideoButton">Carregar Vídeo</button>
    </div>

    <div id="main-content">
      <section id="player-section">
        <div id="player-wrapper">
          <div id="player-container">
            <div id="player"></div>
          </div>
          <div id="custom-controls">
            <button id="play-pause-btn">
              <svg id="play-icon" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"></path>
              </svg>
              <svg id="pause-icon" viewBox="0 0 24 24" style="display: none">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
              </svg>
            </button>
            <input type="range" id="seek-slider" value="0" min="0" step="1" />
            <div id="time-display">00:00 / 00:00</div>
          </div>
        </div>
      </section>

      <section id="chat-section">
        <div id="chat-container">
          <h2>Chat em Tempo Real</h2>
          <div id="chat-log"></div>
          <div id="chat-input-area">
            <input type="text" id="username-input" placeholder="Seu nome" />
            <input
              type="text"
              id="chat-message-input"
              placeholder="Digite uma mensagem..." />
            <button id="send-chat-btn">Enviar</button>
          </div>
        </div>
      </section>
    </div>

    <p id="status">A iniciar...</p>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      // Variáveis globais
      let player, webSocket, uiUpdater;
      let isActionFromNetwork = false;
      let isSeeking = false;

      // Referências aos elementos da UI
      const statusElement = document.getElementById("status");
      const youtubeUrlInput = document.getElementById("youtubeUrl");
      const loadVideoButton = document.getElementById("loadVideoButton");
      const playPauseBtn = document.getElementById("play-pause-btn");
      const playIcon = document.getElementById("play-icon");
      const pauseIcon = document.getElementById("pause-icon");
      const seekSlider = document.getElementById("seek-slider");
      const timeDisplay = document.getElementById("time-display");
      const chatLog = document.getElementById("chat-log");
      const usernameInput = document.getElementById("username-input");
      const chatMessageInput = document.getElementById("chat-message-input");
      const sendChatBtn = document.getElementById("send-chat-btn");

      // --- 1. Inicialização do Player do YouTube ---
      function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
          height: "100%",
          width: "100%",
          videoId: "",
          playerVars: { controls: 0, rel: 0, showinfo: 0, modestbranding: 1 },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });
      }

      // --- 2. Lógica do Player e WebSocket ---
      function onPlayerReady() {
        statusElement.textContent = "Player pronto. A ligar ao servidor...";
        connectWebSocket();
        setupUIEventListeners();
      }

      function onPlayerStateChange(event) {
        updatePlayPauseButton(event.data);
        if (isActionFromNetwork || isSeeking) {
          return;
        }

        let commandType = null;
        switch (event.data) {
          case YT.PlayerState.PLAYING:
            commandType = "PLAY";
            break;
          case YT.PlayerState.PAUSED:
            commandType = "PAUSE";
            break;
        }
        if (commandType) {
          // CORREÇÃO: Usa a nova função sendCommand com um objeto como argumento
          sendCommand({
            type: commandType,
            videoId: player.getVideoData().video_id,
            currentTime: player.getCurrentTime(),
          });
        }
      }

      // --- 3. Conexão WebSocket ---
      function connectWebSocket() {
        const wsUrl = "ws://localhost:8080/watchparty";
        webSocket = new WebSocket(wsUrl);
        webSocket.onopen = () =>
          (statusElement.textContent = "Ligado ao servidor de Watch Party!");
        webSocket.onmessage = (event) =>
          handleServerCommand(JSON.parse(event.data));
        webSocket.onclose = () => {
          statusElement.textContent =
            "Desligado. A tentar ligar novamente em 5 segundos...";
          setTimeout(connectWebSocket, 5000);
        };
        webSocket.onerror = () =>
          (statusElement.textContent =
            "Erro de ligação. Verifique se o servidor está a correr.");
      }

      // --- 4. Manipulação de Comandos ---
      function handleServerCommand(command) {
        if (!player || typeof player.getPlayerState !== "function") return;
        isActionFromNetwork = true;

        switch (command.type) {
          case "LOAD":
          case "SEEK":
          case "PLAY":
          case "PAUSE":
            handleVideoCommand(command);
            break;
          case "CHAT":
            displayChatMessage(command.sender, command.message);
            break;
        }
        // Importante: resetar o flag após a ação ser processada
        setTimeout(() => {
          isActionFromNetwork = false;
        }, 100);
      }

      function handleVideoCommand(command) {
        const currentVideoIdOnPlayer = player.getVideoData()?.video_id;
        if (command.videoId && command.videoId !== currentVideoIdOnPlayer) {
          player.loadVideoById(command.videoId, command.currentTime);
        }
        if (command.type === "PLAY") {
          player.seekTo(command.currentTime, true);
          player.playVideo();
        } else if (command.type === "PAUSE") {
          player.pauseVideo();
          player.seekTo(command.currentTime, true);
        } else if (command.type === "SEEK" || command.type === "LOAD") {
          player.seekTo(command.currentTime, true);
        }
      }

      // CORREÇÃO: Função genérica para enviar qualquer tipo de comando.
      function sendCommand(command) {
        if (webSocket && webSocket.readyState === WebSocket.OPEN) {
          webSocket.send(JSON.stringify(command));
        } else {
          statusElement.textContent = "Erro: Sem ligação ao servidor.";
        }
      }

      // --- 5. Lógica da UI e Eventos ---
      function setupUIEventListeners() {
        loadVideoButton.addEventListener("click", () => {
          const videoId = extractVideoID(youtubeUrlInput.value.trim());
          if (videoId) {
            // CORREÇÃO: Usa sendCommand com um objeto
            sendCommand({ type: "LOAD", videoId: videoId, currentTime: 0 });
            youtubeUrlInput.value = "";
          } else {
            alert("URL do YouTube inválida!");
          }
        });

        playPauseBtn.addEventListener("click", () => {
          const state = player.getPlayerState();
          state === YT.PlayerState.PLAYING
            ? player.pauseVideo()
            : player.playVideo();
        });

        seekSlider.addEventListener("input", () => {
          isSeeking = true;
        });
        seekSlider.addEventListener("change", () => {
          const seekTime = parseFloat(seekSlider.value);
          isActionFromNetwork = true; // Previne o envio de um evento PAUSE indesejado
          player.seekTo(seekTime, true);
          // CORREÇÃO: Usa sendCommand com um objeto
          sendCommand({
            type: "SEEK",
            videoId: player.getVideoData().video_id,
            currentTime: seekTime,
          });
          isSeeking = false;
          setTimeout(() => {
            isActionFromNetwork = false;
          }, 100);
        });

        sendChatBtn.addEventListener("click", sendChatMessage);
        chatMessageInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendChatMessage();
        });
      }

      // --- 6. Funções Utilitárias ---
      function sendChatMessage() {
        const sender = usernameInput.value.trim();
        const message = chatMessageInput.value.trim();
        if (!sender || !message) {
          alert("Preencha o seu nome e uma mensagem.");
          return;
        }
        sendCommand({ type: "CHAT", sender: sender, message: message });
        chatMessageInput.value = "";
      }

      function displayChatMessage(sender, message) {
        const p = document.createElement("p");
        const strong = document.createElement("strong");
        strong.textContent = `${sender}: `;
        p.appendChild(strong);
        p.appendChild(document.createTextNode(message));
        chatLog.appendChild(p);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function startUIUpdater() {
        if (uiUpdater) clearInterval(uiUpdater);
        uiUpdater = setInterval(() => {
          if (
            player &&
            typeof player.getCurrentTime === "function" &&
            !isSeeking
          ) {
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            seekSlider.max = duration || 0;
            seekSlider.value = currentTime;
            timeDisplay.textContent = `${formatTime(
              currentTime
            )} / ${formatTime(duration)}`;
          }
        }, 250);
      }

      function updatePlayPauseButton(playerState) {
        if (playerState === YT.PlayerState.PLAYING) {
          playIcon.style.display = "none";
          pauseIcon.style.display = "block";
          startUIUpdater();
        } else {
          playIcon.style.display = "block";
          pauseIcon.style.display = "none";
        }
      }

      function formatTime(seconds) {
        const date = new Date(0);
        date.setSeconds(seconds || 0);
        return date.toISOString().slice(14, 19);
      }

      function extractVideoID(url) {
        const regExp =
          /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return match && match[2].length === 11 ? match[2] : null;
      }
    </script>
  </body>
</html>
